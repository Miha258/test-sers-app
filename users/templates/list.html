<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body>
    {% block content %}
    <table class="table">
        <thead>
          <tr>
            <th scope="col">id</th>
            <th scope="col">Email</th>
            <th scope="col">Group</th>
            <th scope="col">Admin</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
            {% for user in users %}
                <tr>
                    <th scope="row">1</th>
                    <td>{{user.id}}</td>
                    <td>{{user.email}}</td>
                    <td>{{user.group}}</td>
                    <td>{{user.admin}}</td>
                    <td>
                        <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal" data-bs-user-id="{{user.id}}">
                            Edit user
                        </a>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% include 'edit.html' %}
    {% include 'create.html' %}
    <script>
        const targetModal = document.getElementById('userModal')
        targetModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget
            const user_id = button.getAttribute('data-bs-user-id')
            document.getElementById('editUserButton').onclick = () => {
                fetch(`http://{{ request.get_host }}/users/edit/${user_id}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        username: document.getElementById('username').value,
                        group_id: document.getElementById('group').value,
                        is_admin: document.getElementById('isAdmin').checked
                    })
                }).then(async response => {
                    if (!response.ok) {
                        const { error } = await response.json()
                        const alert = document.querySelector('.alert')
                        alert.style.display = 'block'
                        alert.innerText = error
                    } else {
                        location.reload()
                    }
                })
            }  
        })
    </script>
    {% endblock %}
</body>
</html>